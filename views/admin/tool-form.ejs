<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= tool.id ? '编辑工具' : '新增工具' %> - XTools</title>
    <link href="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css', settings.cdn_url) %>" rel="stylesheet">
    <link href="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css', settings.cdn_url) %>" rel="stylesheet">
    <link href="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/monokai.css', settings.cdn_url) %>" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard">XTools 管理后台</a>
        </div>
    </nav>

    <div class="container my-4">
        <h2><%= tool.id ? '编辑工具' : '新增工具' %></h2>
        <form action="<%= tool.id ? `/admin/tool/${tool.id}` : '/admin/tool' %>" method="POST" enctype="application/x-www-form-urlencoded">
            <div class="mb-3">
                <label for="name" class="form-label">工具名称</label>
                <input type="text" class="form-control" id="name" name="name" value="<%= tool.name || '' %>" required>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">工具描述</label>
                <textarea class="form-control" id="description" name="description" rows="3" required><%= tool.description || '' %></textarea>
            </div>
            <div class="mb-3">
                <label for="group_id" class="form-label">分组</label>
                <select class="form-select" id="group_id" name="group_id">
                    <option value="">[无分组]</option>
                    <% groups.forEach(function(group) { %>
                        <option value="<%= group.id %>" <%= tool.group_id === group.id ? 'selected' : '' %>><%= group.name %></option>
                    <% }); %>
                </select>
            </div>
            <div class="mb-3">
                <label for="type" class="form-label">工具类型</label>
                <select class="form-select" id="type" name="type" onchange="toggleContentType()">
                    <option value="html" <%= (!tool.type || tool.type === 'html') ? 'selected' : '' %>>HTML 工具</option>
                    <option value="link" <%= tool.type === 'link' ? 'selected' : '' %>>链接工具</option>
                </select>
            </div>
            <div class="mb-3" id="contentWrapper">
                <label for="html_content" class="form-label" id="contentLabel">HTML 内容</label>
                <textarea class="form-control" id="html_content" name="html_content" rows="10" required><%= tool.html_content || '' %></textarea>
            </div>
            <div class="mb-3">
                <label for="api_endpoint" class="form-label">API 端点（可选）</label>
                <input type="text" class="form-control" id="api_endpoint" name="api_endpoint" value="<%= tool.api_endpoint || '' %>">
                <div class="form-text">如果工具需要后端API支持，请在这里填写API端点</div>
            </div>
            <div class="mb-3">
                <a href="/admin/dashboard" class="btn btn-secondary">返回</a>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>

    <script src="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js', settings.cdn_url) %>"></script>
    <script src="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.js', settings.cdn_url) %>"></script>
    <script src="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/xml/xml.js', settings.cdn_url) %>"></script>
    <script src="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/javascript/javascript.js', settings.cdn_url) %>"></script>
    <script src="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/css/css.js', settings.cdn_url) %>"></script>
    <script src="<%= replaceCdnUrl('https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/htmlmixed/htmlmixed.js', settings.cdn_url) %>"></script>
    <script>
    function toggleContentType() {
        const type = document.getElementById('type').value;
        const contentLabel = document.getElementById('contentLabel');
        const contentWrapper = document.getElementById('contentWrapper');
        const textArea = document.getElementById('html_content');

        if (type === 'link') {
            contentLabel.textContent = '链接地址';
            textArea.setAttribute('placeholder', '请输入完整的URL地址，如 https://www.example.com');
            if (editor) {
                editor.toTextArea();
                editor = null;
            }
        } else {
            contentLabel.textContent = 'HTML 内容';
            textArea.removeAttribute('placeholder');
            if (!editor) {
                editor = CodeMirror.fromTextArea(textArea, {
                    mode: "htmlmixed",
                    theme: "monokai",
                    lineNumbers: true,
                    autoCloseTags: true,
                    autoCloseBrackets: true,
                    indentUnit: 4,
                    lineWrapping: true
                });
            }
        }
    }

    let editor;

    // 等待 DOM 加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        var textArea = document.getElementById('html_content');
        if (textArea) {
            const type = document.getElementById('type').value;
            if (type !== 'link') {
                editor = CodeMirror.fromTextArea(textArea, {
                    mode: "htmlmixed",
                    theme: "monokai",
                    lineNumbers: true,
                    autoCloseTags: true,
                    autoCloseBrackets: true,
                    indentUnit: 4,
                    lineWrapping: true
                });
            }
            
            // 确保表单提交时更新 textarea 的值
            var form = textArea.closest('form');
            if (form) {
                form.addEventListener('submit', function() {
                    if (editor) {
                        editor.save();
                    }
                });
            }
        }
        toggleContentType();
    });
</script>
</body>
</html>
